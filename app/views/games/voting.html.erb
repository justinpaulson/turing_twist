<%= turbo_stream_from @game %>

<style>
  /* Mobile responsive styles for voting page */
  @media (max-width: 768px) {
    .voting-container {
      padding: 0.5rem !important;
    }

    .voting-container .box-header {
      font-size: 1.2rem !important;
      padding: 0.75rem 0.5rem;
    }

    .voting-container .box {
      padding: 0 !important;
    }

    .voting-progress-box {
      padding: 1rem !important;
      margin-bottom: 1rem !important;
    }

    .voting-progress-box > div:first-child {
      font-size: 1rem !important;
    }

    .voting-progress-box > div:nth-child(2) {
      font-size: 0.8rem !important;
    }

    .voting-progress-box > div:last-child {
      font-size: 0.75rem !important;
    }

    .player-header {
      padding: 1rem !important;
      gap: 0.75rem !important;
    }

    .player-avatar-container {
      width: 45px !important;
      height: 45px !important;
    }

    .player-name {
      font-size: 1.1rem !important;
    }

    .player-name .voted-badge {
      font-size: 0.7rem !important;
    }

    .player-answer-count {
      font-size: 0.75rem !important;
    }

    .vote-button {
      padding: 0.5rem 1rem !important;
      font-size: 0.8rem !important;
    }

    .player-answers-container {
      padding: 1rem !important;
    }

    .answer-box {
      padding: 0.75rem !important;
    }

    .answer-question {
      font-size: 0.7rem !important;
    }

    .answer-content {
      font-size: 0.85rem !important;
    }

    .vote-count-box {
      padding: 1rem !important;
    }

    .vote-count-box > div:first-child {
      font-size: 1rem !important;
    }

    .vote-count-box > div:last-child {
      font-size: 0.8rem !important;
    }

    .voting-complete-box {
      padding: 1.5rem 1rem !important;
    }

    .voting-complete-box > div:first-child {
      font-size: 1rem !important;
      margin-bottom: 1rem !important;
    }

    .voting-complete-box .btn {
      font-size: 1.1rem !important;
      padding: 1rem 1.5rem !important;
    }

    .vote-modal-content {
      padding: 1.5rem !important;
      width: 95% !important;
    }

    .vote-modal-content h3 {
      font-size: 1.2rem !important;
    }

    .vote-modal-content p {
      font-size: 0.95rem !important;
      margin-bottom: 1rem !important;
    }

    .vote-modal-content strong {
      font-size: 1.1rem !important;
    }

    .vote-modal-buttons {
      flex-direction: column !important;
    }

    .vote-modal-buttons .btn,
    .vote-modal-buttons button {
      padding: 0.75rem !important;
      font-size: 0.9rem !important;
    }

    .voting-container > p {
      font-size: 0.95rem !important;
      padding: 0 0.5rem;
    }

    .answers-grid {
      gap: 1rem !important;
      margin-bottom: 1rem !important;
    }

    .answer-grid-inner {
      gap: 0.75rem !important;
    }
  }
</style>

<div class="container voting-container">
  <div class="box-header" style="margin-bottom: 1rem; text-align: center; font-size: 1.5rem;">
    ► TIME TO VOTE!
  </div>
  <p style="font-family: 'Courier New', monospace; text-align: center; margin-bottom: 1rem; font-size: 1.1rem;">Review all answers and vote for the <%= Vote::MAX_VOTES_PER_PLAYER %> players you think are AI.</p>

  <!-- Voting Progress -->
  <% if @current_player && !@current_player.is_eliminated? %>
    <div class="box voting-progress-box" style="background: <%= @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER ? '#000000' : '#ffffff' %>; color: <%= @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER ? '#ffffff' : '#000000' %>; padding: 1.5rem; margin-bottom: 2rem; text-align: center; border: 4px solid #000000;">
      <div style="font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em;">
        <% if @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER %>
          ■ VOTING COMPLETE (<%= @my_votes.count %>/<%= Vote::MAX_VOTES_PER_PLAYER %>)
        <% else %>
          ► YOUR VOTES: <%= @my_votes.count %>/<%= Vote::MAX_VOTES_PER_PLAYER %>
        <% end %>
      </div>
      <% if @my_votes.any? %>
        <div style="font-family: 'Courier New', monospace; font-size: 0.95rem; margin-top: 0.75rem; opacity: 0.9;">
          You voted for: <strong><%= @my_votes.map { |v| v.voted_for.character_name }.join(", ") %></strong>
        </div>
      <% end %>
      <% if @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER %>
        <div style="font-family: 'Courier New', monospace; font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
          <%= image_tag "hourglass.svg", style: "width: 16px; height: 16px; filter: invert(1);" %>
          Waiting for other players to vote...
        </div>
      <% end %>

      <!-- Host Skip Button - Only show for host after 2 minutes if voting is not complete -->
      <% if @current_player&.is_host? && !@game.voting_complete? %>
        <% voting_elapsed = @game.voting_started_at ? Time.current - @game.voting_started_at : 0 %>
        <% show_button = voting_elapsed >= 2.minutes %>
        <% border_color = @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER ? '#ffffff' : '#000000' %>
        <% button_bg = @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER ? '#ffffff' : '#000000' %>
        <% button_color = @my_votes.count >= Vote::MAX_VOTES_PER_PLAYER ? '#000000' : '#ffffff' %>
        <div id="hostSkipContainer" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid <%= border_color %>; <%= show_button ? '' : 'display: none;' %>">
          <%= link_to "SKIP REMAINING VOTES ►", skip_remaining_votes_game_path(@game),
              data: { turbo_method: :post, turbo_confirm: "Are you sure? This will complete voting and calculate scores without remaining votes." },
              class: "btn",
              style: "font-size: 1.1rem; padding: 1rem 2rem; background: #{button_bg}; color: #{button_color};" %>
          <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; margin-top: 0.75rem; opacity: 0.7;">
            Host: Skip if players have left the game
          </div>
        </div>
        <% unless show_button %>
          <script>
            // Show skip button after 2 minutes
            setTimeout(function() {
              const container = document.getElementById('hostSkipContainer');
              if (container) {
                container.style.display = 'block';
              }
            }, <%= (2.minutes - voting_elapsed) * 1000 %>);
          </script>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- Display all answers grouped by player -->
  <div class="answers-grid" style="display: grid; gap: 1.5rem; margin-bottom: 2rem;">
    <% @answers_by_player.each do |player, player_answers| %>
      <% already_voted = @voted_for_ids&.include?(player.id) %>
      <div class="box" style="padding: 0; <%= already_voted ? 'background: #000000; color: #ffffff; border: 6px solid #000000;' : 'border: 4px solid #000000;' %>">
        <!-- Player Header -->
        <div class="player-header" style="display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; padding: 1.5rem; background: <%= already_voted ? '#000000' : '#ffffff' %>; border-bottom: 4px solid <%= already_voted ? '#ffffff' : '#000000' %>;">
          <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
            <div class="player-avatar-container" style="width: 60px; height: 60px; background: <%= already_voted ? '#ffffff' : '#000000' %>; border: 3px solid <%= already_voted ? '#ffffff' : '#000000' %>; display: flex; align-items: center; justify-content: center; padding: 0.35rem; flex-shrink: 0;">
              <%= image_tag player.character_avatar_path, style: "width: 100%; height: 100%; object-fit: contain;" %>
            </div>
            <div style="flex: 1; min-width: 0;">
              <h3 class="player-name" style="margin: 0; font-size: 1.5rem; text-transform: uppercase; font-family: 'Courier New', monospace; letter-spacing: 0.05em; <%= already_voted ? 'color: #ffffff;' : 'color: #000000;' %>; word-wrap: break-word;">
                <%= player.character_name %>
                <% if already_voted %>
                  <span class="voted-badge" style="font-size: 0.9rem; opacity: 0.9;"> ✓ VOTED</span>
                <% end %>
              </h3>
              <div class="player-answer-count" style="font-family: 'Courier New', monospace; font-size: 0.85rem; margin-top: 0.25rem; opacity: 0.8; <%= already_voted ? 'color: #ffffff;' : 'color: #000000;' %>">
                <%= player_answers.count %> <%= 'answer'.pluralize(player_answers.count) %> from <%= Game::TOTAL_ROUNDS %> questions
              </div>
            </div>
          </div>
          <% if @current_player && !@current_player.is_eliminated? && @my_votes.count < Vote::MAX_VOTES_PER_PLAYER && !already_voted && player != @current_player %>
            <button onclick="openVoteModal(<%= player.id %>, '<%= player.character_name %>')" class="btn vote-button" style="flex-shrink: 0; background: <%= already_voted ? '#ffffff' : '#000000' %>; color: <%= already_voted ? '#000000' : '#ffffff' %>; padding: 0.75rem 1.5rem; white-space: nowrap; font-family: 'Courier New', monospace; text-transform: uppercase; font-size: 0.9rem;">
              ► Vote AI
            </button>
          <% end %>
        </div>

        <!-- Player's Answers -->
        <div class="player-answers-container" style="padding: 1.5rem; background: <%= already_voted ? '#000000' : '#ffffff' %>;">
          <div class="answer-grid-inner" style="display: grid; gap: 1rem;">
            <% player_answers.each do |answer| %>
              <div class="answer-box" style="padding: 1rem; border: 2px solid <%= already_voted ? '#ffffff' : '#000000' %>; background: <%= already_voted ? '#000000' : '#ffffff' %>;">
                <div class="answer-question" style="font-family: 'Courier New', monospace; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; opacity: 0.7; <%= already_voted ? 'color: #ffffff;' : 'color: #000000;' %>">
                  ► Question <%= answer.round.round_number %>: <%= answer.round.question %>
                </div>
                <p class="answer-content" style="margin: 0; line-height: 1.6; font-family: 'Courier New', monospace; font-size: 0.95rem; <%= already_voted ? 'color: #ffffff;' : 'color: #000000;' %>"><%= answer.content %></p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Vote count -->
  <div class="box vote-count-box" style="text-align: center; padding: 1.5rem; margin-top: 2rem;">
    <div style="font-family: 'Courier New', monospace; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.05em;">
      <strong><%= @game.votes.count %></strong> / <strong><%= @game.active_human_players.count * Vote::MAX_VOTES_PER_PLAYER %></strong> TOTAL VOTES CAST
    </div>
    <div style="font-family: 'Courier New', monospace; font-size: 0.95rem; margin-top: 0.5rem; opacity: 0.8;">
      <%= @game.active_human_players.count { |p| @game.votes.where(voter: p).count >= Vote::MAX_VOTES_PER_PLAYER } %> / <%= @game.active_human_players.count %> players finished voting
    </div>
  </div>

  <!-- Check if voting is complete -->
  <% if @game.voting_complete? %>
    <div class="box voting-complete-box" style="background: #000000; color: #ffffff; padding: 2rem; margin: 2rem 0; text-align: center;">
      <div style="font-family: 'Courier New', monospace; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1.5rem;">
        ■ VOTING COMPLETE
      </div>
      <%= link_to "VIEW FINAL RESULTS ►", game_path(@game), class: "btn", style: "font-size: 1.3rem; padding: 1.5rem 3rem; background: #ffffff; color: #000000;" %>
    </div>
  <% end %>
</div>

<!-- Voting Modal -->
<div id="voteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
  <div class="box vote-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2.5rem; max-width: 500px; width: 90%;">
    <h3 style="margin: 0 0 1.5rem 0; text-transform: uppercase; text-align: center; font-size: 1.5rem;">■ CONFIRM YOUR VOTE</h3>
    <p style="font-family: 'Courier New', monospace; text-align: center; font-size: 1.1rem; margin-bottom: 2rem;">
      Are you sure you want to vote for<br><strong style="font-size: 1.3rem; text-transform: uppercase;" id="voteName"></strong><br>as the AI?
    </p>

    <%= form_with url: game_votes_path(@game), method: :post, data: { turbo: false } do |f| %>
      <%= f.hidden_field :voted_for_id, id: "votePlayerId" %>
      <div class="vote-modal-buttons" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <%= f.submit "YES, VOTE", class: "btn", style: "flex: 1; background: #000000; color: #ffffff; padding: 1rem; font-size: 1rem;" %>
        <button type="button" onclick="closeVoteModal()" class="btn" style="flex: 1; background: #ffffff; color: #000000; padding: 1rem; font-size: 1rem; border: 4px solid #000000;">
          CANCEL
        </button>
      </div>
    <% end %>
  </div>
</div>

<script>
function openVoteModal(playerId, playerName) {
  document.getElementById('votePlayerId').value = playerId;
  document.getElementById('voteName').textContent = playerName;
  document.getElementById('voteModal').style.display = 'block';
}

function closeVoteModal() {
  document.getElementById('voteModal').style.display = 'none';
}

// Check if voting is complete and redirect to results
<% unless @game.completed? || @game.voting_complete? %>
  function checkVotingStatus() {
    fetch('<%= voting_game_path(@game) %>', {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.voting_complete || data.game_completed) {
        // Stop polling and redirect to results
        if (window.pollInterval) {
          clearInterval(window.pollInterval);
        }
        window.location.href = '<%= game_path(@game) %>';
      }
    })
    .catch(error => {
      console.error('Error checking voting status:', error);
    });
  }

  // Check immediately on page load
  checkVotingStatus();

  // Poll every 3 seconds to detect when host skips remaining votes
  window.pollInterval = setInterval(checkVotingStatus, 3000);
<% end %>
</script>
